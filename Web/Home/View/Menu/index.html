<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <title> 系统接入平台-菜单管理 </title>

        <meta name="description" content="Minimal empty page" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- basic styles -->
        <link href="{$webroot}assets/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="{$webroot}assets/css/font-awesome.min.css" />

        <!--[if IE 7]>
        <link rel="stylesheet" href="{$webroot}assets/css/font-awesome-ie7.min.css" />
        <![endif]-->

        <!-- page specific plugin styles -->
        <link rel="stylesheet" href="{$webroot}assets/css/jquery-ui-1.10.3.full.min.css" />
        <link rel="stylesheet" href="{$webroot}assets/css/jquery.gritter.css" />
        <link rel="stylesheet" href="{$webroot}assets/css/select2.css" />
        <!--link rel="stylesheet" href="{$webroot}assets/css/chosen.css" /-->
        <link rel="stylesheet" href="{$webroot}assets/css/ui.jqgrid.css" />

        <!-- fonts -->
        <link rel="stylesheet" href="{$webroot}assets/css/ace-fonts.css" />

        <!-- ace styles -->
        <link rel="stylesheet" href="{$webroot}assets/css/ace.min.css" />
        <link rel="stylesheet" href="{$webroot}assets/css/ace-rtl.min.css" />
        <link rel="stylesheet" href="{$webroot}assets/css/ace-skins.min.css" />

        <!--[if lte IE 8]>
        <link rel="stylesheet" href="{$webroot}assets/css/ace-ie.min.css" />
        <![endif]-->

        <!-- inline styles related to this page -->

        <!-- ace settings handler -->

        <!--script src="{$webroot}assets/js/ace-extra.min.js"></script-->
        <script src="{$webroot}assets/js/uncompressed/ace-extra.js"></script>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->

        <!--[if lt IE 9]>
        <script src="{$webroot}assets/js/html5shiv.js"></script>
        <script src="{$webroot}assets/js/respond.min.js"></script>
        <![endif]-->
        <style>
        .icon-times-circle:before {
            content: "\f057";
        }
        </style>
    </head>

    <body>
        <include file="./Tpl/header.html" />

        <div class="main-container" id="main-container">
            <script type="text/javascript">
                try{ace.settings.check('main-container' , 'fixed')}catch(e){}
            </script>

            <div class="main-container-inner">
                <include file="./Tpl/sidebar.html" />

                <div class="main-content">

                    <div class="breadcrumbs" id="breadcrumbs">
                        <script type="text/javascript">
                            try{ace.settings.check('breadcrumbs' , 'fixed')}catch(e){}
                        </script>

                        <ul class="breadcrumb">
                            <li>
                                <i class="icon-home home-icon"></i>
                                <a href="#">首页</a>
                            </li>
                            <li class="active">菜单管理</li>
                        </ul><!-- .breadcrumb -->

                        <div class="nav-search" id="nav-search">
                            <form class="form-search">
                                <span class="input-icon">
                                    <select id="saved_menu" onchange="menuChange();">
                                        <option value="0"> --- </option>
                                        <foreach name="menus" item="vo">
                                            <option value='{$vo["id"]}'> {$vo["date_time"]} </option>
                                        </foreach>
                                    </select>
                                    
                                    &nbsp;
                                    <button class="btn btn-xs btn-warning" type="button" onClick="saveMenu();">
                                        <i class="icon-cloud-download bigger-110"></i>&nbsp;保存菜单
                                    </button>
                                    &nbsp;
                                    <button class="btn btn-xs btn-warning" type="button" onClick="downloadMenu();">
                                        <i class="icon-cloud-download bigger-110"></i>&nbsp;下载菜单
                                    </button>
                                    &nbsp;
                                    <button class="btn btn-xs btn-success" type="button" onClick="uploadMenu();">
                                        <i class="icon-cloud-upload bigger-110"></i>&nbsp;上传菜单
                                    </button>
                                    &nbsp;
                                    <button class="btn btn-xs btn-danger" type="button" onClick="addGroupButtonClicked();">
                                        <i class="icon-times-circle bigger-110"></i>&nbsp;删除菜单
                                    </button>
                                </span>
                            </form>
                        </div><!-- #nav-search -->
                    </div>

                    <div class="page-content">
                        <!--div class="page-header">
                            <h1>
                                <small>
                                    选择主菜单: &nbsp;&nbsp;&nbsp;
                                    <select id="groupSelector" style="width:200px">
                                        <foreach name="groups" item="vo">
                                            <option value='{$vo["id"]}'>{$vo["name"]}</option>
                                        </foreach>
                                    </select>
                                    &nbsp;
                                    <button class="btn btn-xs btn-info" type="button" onClick="addGroupButtonClicked();">
                                        <i class="icon-plus bigger-110"></i>增加
                                    </button>
                                    
                                    <button class="btn btn-xs btn-info" type="button" onClick="editGroupButtonClicked();">
                                        <i class="icon-pencil bigger-110"></i>改名
                                    </button>
                                    
                                    <button class="btn btn-xs btn-info" type="button" onClick="editGroupButtonClicked();">
                                        <i class="icon-arrow-up bigger-110"></i>上移
                                    </button>
                                    
                                    <button class="btn btn-xs btn-info" type="button" onClick="delGroupButtonClicked();">
                                        <i class="icon-minus bigger-110"></i>删除
                                    </button>
                                    
                                </small>
                            </h1>
                            
                        </div--><!-- /.page-header -->

                        <div class="row">
                            <div class="col-md-12">
                                <!-- PAGE CONTENT BEGINS -->
                                <table id="grid-table"></table>
                                <div id="grid-pager"></div>
                                
                                <!--hr />
                                
                                <div class="row">
                                    <button class="btn btn-xs btn-danger" type="button" onClick="clearForm();">
                                        <i class="icon-minus bigger-110"></i>清除
                                    </button>
                                    
                                    <button class="btn btn-xs btn-info pull-right"
                                      type="button" onClick="addContentButtonClicked();">
                                        <i class="icon-plus bigger-110"></i><span id="submit_bt">添加</span>
                                    </button>
                                </div-->
                                
                                <div id="modal-add-group" class="modal fade" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header no-padding">
                                                <div class="table-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                        <span class="white">&times;</span>
                                                    </button>
                                                    增加栏目
                                                </div>
                                            </div>

                                            <div class="modal-body no-padding">
                                                <table class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                    <thead>
                                                        <tr>
                                                            <th> 栏目名称: </th>
                                                        </tr>
                                                    </thead>

                                                    <tbody>
                                                        <tr>
                                                            <td width="100%">
                                                                <input type="text" id="add-group-name" placeholder="名称" class="col-xs-12 col-sm-12">
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div class="modal-footer no-margin-top">
                                                <button class="btn btn-sm btn-danger pull-left" data-dismiss="modal">
                                                    <i class="icon-remove"></i>
                                                    关闭
                                                </button>

                                                <button class="btn btn-sm btn-primary pull-right" onClick="submitAddGroup();">
                                                    <i class="icon-plus"></i>
                                                    提交
                                                </button>
                                            </div>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal-dialog -->
                                </div>
                                
                                <div id="modal-edit-group" class="modal fade" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header no-padding">
                                                <div class="table-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                        <span class="white">&times;</span>
                                                    </button>
                                                    编辑栏目
                                                </div>
                                            </div>

                                            <div class="modal-body no-padding">
                                                <table class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                    <thead>
                                                        <tr>
                                                            <th> 栏目名称: </th>
                                                        </tr>
                                                    </thead>

                                                    <tbody>
                                                        <tr>
                                                            <td width="100%">
                                                                <input type="text" id="edit-group-id" class="hide">
                                                                
                                                                <input type="text" id="edit-group-name" placeholder="名称" class="col-xs-12 col-sm-12">
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div class="modal-footer no-margin-top">
                                                <button class="btn btn-sm btn-danger pull-left" data-dismiss="modal">
                                                    <i class="icon-remove"></i>
                                                    关闭
                                                </button>

                                                <button class="btn btn-sm btn-primary pull-right" onClick="submitEditGroup();">
                                                    <i class="icon-plus"></i>
                                                    提交
                                                </button>
                                            </div>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal-dialog -->
                                </div>
                                
                                <div id="modal-del-group" class="modal fade" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header no-padding">
                                                <div class="table-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                        <span class="white">&times;</span>
                                                    </button>
                                                    删除栏目
                                                </div>
                                            </div>

                                            <div class="modal-body no-padding">
                                                <table class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                    <thead>
                                                        <tr>
                                                            <th> 栏目名称: </th>
                                                        </tr>
                                                    </thead>

                                                    <tbody>
                                                        <tr>
                                                            <td width="100%">
                                                                <spen id="del_name"></span>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div class="modal-footer no-margin-top">
                                                <button class="btn btn-sm btn-danger pull-left" data-dismiss="modal">
                                                    <i class="icon-remove"></i>
                                                    关闭
                                                </button>

                                                <button class="btn btn-sm btn-primary pull-right" onClick="submitDelGroup();">
                                                    <i class="icon-plus"></i>
                                                    删除
                                                </button>
                                            </div>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal-dialog -->
                                </div>
                                    
                                <!-- PAGE CONTENT ENDS -->
                            </div><!-- /.col -->
                        </div><!-- /.row -->

                        <hr />
                        <div class="well">
                            <h4 class="green smaller lighter">Debug</h4>
                            <p id="debug_text"></p>
                        </div>

                    </div><!-- /.page-content -->
                </div><!-- /.main-content -->

            </div><!-- /.main-container-inner -->
        </div><!-- /.main-container -->

<!-- basic scripts -->

<!--[if !IE]> -->

<script type="text/javascript">
    window.jQuery || document.write("<script src='{$webroot}assets/js/jquery-2.0.3.min.js'>"+"<"+"/script>");
</script>

<!-- <![endif]-->

<!--[if IE]>
<script type="text/javascript">
window.jQuery || document.write("<script src='{$webroot}assets/js/jquery-1.10.2.min.js'>"+"<"+"/script>");
</script>
<![endif]-->

<script type="text/javascript">
    if("ontouchend" in document) document.write("<script src='{$webroot}assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
</script>
<script src="{$webroot}assets/js/bootstrap.min.js"></script>
<script src="{$webroot}assets/js/typeahead-bs2.min.js"></script>

<!-- page specific plugin scripts -->
<script src="{$webroot}assets/js/jquery.gritter.min.js"></script>
<script src="{$webroot}assets/js/select2.min.js"></script>
<!--script src="{$webroot}assets/js/json.js"></script-->
<script src="{$webroot}assets/js/jqGrid/jquery.jqGrid.min.js"></script>
<script src="{$webroot}assets/js/jqGrid/i18n/grid.locale-cn.js"></script>

<!-- ace scripts -->
<script src="{$webroot}assets/js/ace-elements.min.js"></script>
<script src="{$webroot}assets/js/ace.min.js"></script>

<!-- inline scripts related to this page -->
<script>
    var userGroupList = [];
    
    var grid_data = new Array();
    var gridColNames = ['排序','名称','上级菜单','类型','参数'];
    var colModel = [
                        {name:'sequence', width:50, sorttype:"int", editable: true},
                        {name:'name', width:150, sorttype:"string", editable:true},
                        {name:'parent', width:150, sorttype:"string", editable:true, edittype:'select', editoptions:{value:'-1:--主菜单--'}},
                        {name:'type', width:150, editable:true, edittype:'select', editoptions:{value:'0:--容器--;1:单条图文;2:显示栏目;3:自定义动作;4:跳转URL'}},
                        {name:'parameter', editable: true}
                    ];
    
    var windowsStat = function(){
        var winWidth = 0;
        var winHeight = 0;
        
        // 获取窗口宽度
              if (window.innerWidth)
              winWidth = window.innerWidth;
              else if ((document.body) && (document.body.clientWidth))
              winWidth = document.body.clientWidth;
              // 获取窗口高度
              if (window.innerHeight)
              winHeight = window.innerHeight;
              else if ((document.body) && (document.body.clientHeight))
              winHeight = document.body.clientHeight;
              // 通过深入 Document 内部对 body 进行检测，获取窗口大小
              if (document.documentElement && document.documentElement.clientHeight && document.documentElement.clientWidth){
                  winHeight = document.documentElement.clientHeight;
                  winWidth = document.documentElement.clientWidth;
              }
        
        return [winWidth,winHeight];
    }
    
    var setFormCenter = function(formId){
        var windowsStatArr = windowsStat();
        var winWidth = windowsStatArr[0];
        var winHeight = windowsStatArr[1];
        
        var dlgDiv = $(formId);
        var parentDiv = dlgDiv.parent(); // div#gbox_list
        var dlgWidth = dlgDiv.width();
        var parentWidth = winWidth;
        var dlgHeight = dlgDiv.height();
        var parentHeight = winHeight;
        
        dlgDiv[0].style.top = Math.round((parentHeight-dlgHeight)/2) + "px";
        dlgDiv[0].style.left = Math.round((parentWidth-dlgWidth)/2) + "px";
    };
    
    var grid_selector = "#grid-table";
    var pager_selector = "#grid-pager";

    jQuery(document).ready(function(){
        //listContents();

        $("#groupSelector").select2({width:"off"});
        $("#groupSelector").on("change", function(e) {reloadGrid(); });
        
        
        jQuery(grid_selector).jqGrid({
            data: grid_data,
            datatype: "local",
            height: 250,
            colNames: gridColNames,
            colModel:colModel,
        
            viewrecords : true,
            rowNum:10,
            rowList:[10,20,30],
            pager : pager_selector,
            altRows: true,
            multiboxonly: true,
        
            loadComplete : function() {
                var table = this;
                setTimeout(function(){
                    updatePagerIcons(table);
                    enableTooltips(table);
                }, 0);
            },
            
            editurl: "{$webroot}menu/dummy",  //nothing is saved
            //editurl: "{$webroot}test/submit",  //nothing is saved
            //editurl: "{$webroot}content/api_content_table_interface",
            caption: "子菜单列表",
            autowidth: true
        });
            
        //navButtons
        jQuery(grid_selector).jqGrid('navGrid',pager_selector,
            {     //navbar options
                edit: true,
                editicon : 'icon-pencil blue',
                add: true,
                addicon : 'icon-plus-sign purple',
                del: true,
                delicon : 'icon-trash red',
                search: false,
                searchicon : 'icon-search orange',
                refresh: true,
                refreshicon : 'icon-refresh green',
                view: true,
                viewicon : 'icon-zoom-in grey',
            },
            {
                //edit record form
                closeAfterEdit: true,
                recreateForm: true,
                jqModal: true,
                viewPagerButtons: false,
                //width: 500,
                beforeShowForm : function(e) {
                    var form = $(e[0]);
                    form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />');
                    
                    var selectedId = $(grid_selector).jqGrid("getGridParam", "selrow");
                    var currentParent = "";
                    
                    var topMenu = new Array();
                    for(var key in grid_data){
                        var line = grid_data[key];
                        if(line["type"] == "--容器--"){
                            topMenu.push(line);
                        }
                        if(line["id"] == selectedId) currentParent = line["parent"];
                    }
                    var isCurrentTop = false;
                    var additionStr = "";
                    for(var key in topMenu){
                        var selected = "";
                        if(topMenu[key]["name"] == currentParent) selected = ' selected="selected"';
                        additionStr += '<option value="' + topMenu[key]["id"] + '"'+selected+'>';
                        additionStr += topMenu[key]["name"];
                        additionStr += '</option>';
                        
                        if(topMenu[key]["id"] == selectedId) isCurrentTop = true;
                    }
                    
                    $("#parent").append(additionStr);
                    
                    if(topMenu.length == 3 && !isCurrentTop){
                        $("#parent option[value='-1']").remove();
                    }
                    
                    $("#parent option[value='"+selectedId+"']").remove();
                    
                    style_edit_form(form);
                },
                beforeSubmit : function(postdata, formid) {
                    if($.trim($("#sequence").val()) == ""){
                        return[false,"排序不能为空"];
                    }
                    if($.trim($("#name").val()) == ""){
                        return[false,"名称不能为空"];
                    }
                    if($.trim($("#type").val()) != "0" && $.trim($("#parameter").val()) == ""){
                        return[false,"非容器类型参数不能为空"];
                    }
                    
                    var selectedId = postdata["grid-table_id"];
                    var isCurrentTop = false;
                    var currentName = "";
                    
                    for(var key in grid_data){
                        var line = grid_data[key];
                        if(line["id"] == selectedId){
                            if(line["parent"] == "--主菜单--") isCurrentTop = true;
                            currentName = line["name"];
                        }
                    }
                    
                    if(isCurrentTop && $("#parent").val() != "-1"){
                        var hasSubButton = false;
                        for(var key in grid_data){
                            var line = grid_data[key];
                            if(line["parent"] == currentName){
                                hasSubButton = true;
                            }
                        }
                        if(hasSubButton) return[false,"当前主菜单有子菜单，不能改变上级菜单"];
                    }
                    
                    if(!isCurrentTop && $("#type").val() == 0){
                        return[false,"非主菜单不能选择容器类型"];
                    }
                    return[true,"OK"];
                },
                afterSubmit : function(response, postdata) {
                    var line = new Array();
                    line["sequence"] = postdata["sequence"];
                    line["name"] = postdata["name"];
                    line["parameter"] = postdata["parameter"];
                    line["id"] = postdata["id"];
                    
                    if(postdata["parent"] == -1) line["parent"] = "--主菜单--";
                    else{
                        for(var key in grid_data){
                            var dataline = grid_data[key];
                            if(postdata["parent"] == dataline["id"]){
                                line["parent"] = dataline["name"];
                            }
                        }
                    }
                    //0:--容器--;1:单条图文;2:显示栏目;3:自定义动作;4:跳转URL
                    switch(postdata["type"]){
                        case "0":
                            line["type"] = "--容器--";
                            line["parameter"] = "";
                        break;
                        case "1":
                            line["type"] = "单条图文";
                        break;
                        case "2":
                            line["type"] = "显示栏目";
                        break;
                        case "3":
                            line["type"] = "自定义动作";
                        break;
                        case "4":
                            line["type"] = "跳转URL";
                        break;
                    }
                    
                    var oldName = "";
                    for(var key in grid_data){
                        var dataline = grid_data[key];
                        if(dataline["id"] == line["id"]){
                            oldName = dataline["name"];
                            grid_data[key] = line;
                        }
                    }
                    
                    for(var key in grid_data){
                        if(grid_data[key]["parent"] == oldName){
                            grid_data[key]["parent"] = line["name"];
                        }
                    }
                    
                    jQuery(grid_selector).jqGrid("clearGridData").jqGrid('setGridParam',{
                        data:grid_data
                    }).trigger('reloadGrid');
                    
                    return [true,"OK",line["id"]];
                },
                afterComplete : function (response, postdata, formid) {
                }
            },
            {
                //new record form
                closeAfterAdd: true,
                recreateForm: true,
                viewPagerButtons: false,
                jqModal: true,
                //width: 500,
                beforeShowForm : function(e) {
                    var form = $(e[0]);
                    form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />');
                    
                    var topMenu = new Array();
                    for(var key in grid_data){
                        var line = grid_data[key];
                        if(line["type"] == "--容器--"){
                            topMenu.push(line);
                        }
                    }
                    
                    var additionStr = "";
                    for(var key in topMenu){
                        additionStr += '<option value="' + topMenu[key]["id"] + '">';
                        additionStr += topMenu[key]["name"];
                        additionStr += '</option>';
                    }
                    
                    $("#parent").append(additionStr);
                    
                    if(topMenu.length == 3){
                        $("#parent option[value='-1']").remove();
                    }
                    
                    style_edit_form(form);
                },
                beforeSubmit : function(postdata, formid) {
                    if($.trim($("#sequence").val()) == ""){
                        return[false,"排序不能为空"];
                    }
                    if($.trim($("#name").val()) == ""){
                        return[false,"名称不能为空"];
                    }
                    if($.trim($("#type").val()) != "0" && $.trim($("#parameter").val()) == ""){
                        return[false,"非容器类型参数不能为空"];
                    }
                    
                    var isCurrentTop = false;
                    var currentParent = $('#parent [value="'+$("#parent").val()+'"]').text();
                    
                    if(currentParent == "--主菜单--") isCurrentTop = true;
                    
                    if(!isCurrentTop && $("#type").val() == 0){
                        return[false,"非主菜单不能选择容器类型"];
                    }
                    
                    return[true,"OK"];
                },
                afterSubmit : function(response, postdata) {
                    var line = new Array();
                    line["sequence"] = postdata["sequence"];
                    line["name"] = postdata["name"];
                    line["parameter"] = postdata["parameter"];
                    
                    var maxId = 0;
                    
                    if(postdata["parent"] == -1) line["parent"] = "--主菜单--";
                    else{
                        for(var key in grid_data){
                            var dataline = grid_data[key];
                            if(postdata["parent"] == dataline["id"]){
                                line["parent"] = dataline["name"];
                            }
                            
                            if(parseInt(dataline["id"]) > maxId) maxId = parseInt(dataline["id"]);
                        }
                    }
                    
                    maxId = String(maxId + 1);
                    line["id"] = maxId;
                    
                    //0:--容器--;1:单条图文;2:显示栏目;3:自定义动作;4:跳转URL
                    switch(postdata["type"]){
                        case "0":
                            line["type"] = "--容器--";
                            line["parameter"] = "";
                        break;
                        case "1":
                            line["type"] = "单条图文";
                        break;
                        case "2":
                            line["type"] = "显示栏目";
                        break;
                        case "3":
                            line["type"] = "自定义动作";
                        break;
                        case "4":
                            line["type"] = "跳转URL";
                        break;
                    }
                    
                    grid_data.push(line);
                    
                    jQuery(grid_selector).jqGrid("clearGridData").jqGrid('setGridParam',{
                        data:grid_data
                    }).trigger('reloadGrid');
                    
                    return [true,"OK",maxId];
                },
                afterComplete : function (response, postdata, formid) {
                    //$(".ui-icon-closethick").trigger('click');
                }
            },
            {
                //delete record form
                recreateForm: true,
                beforeShowForm : function(e) {
                    var form = $(e[0]);
                    
                    var delId = $(grid_selector).jqGrid("getGridParam", "selrow");
                    var delName = "";
                    for(var key in grid_data){
                        if(grid_data[key].id == delId) delName = grid_data[key].name;
                    }
                    
                    $(".delmsg").text("删除菜单: "+delName+"?");
                    setFormCenter("#delmodgrid-table");
                    
                    if(form.data('styled')) return false;
                    form.data('styled', true);
                    form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
                    style_delete_form(form);
                },
                onClick : function(e) {
                    alert(1);
                },
                beforeSubmit : function(postdata, formid) {
                    var selectedId = $(grid_selector).jqGrid("getGridParam", "selrow");
                    var isCurrentTop = false;
                    var currentName = "";
                    
                    for(var key in grid_data){
                        var line = grid_data[key];
                        if(line["parent"] == "--主菜单--" && line["id"] == selectedId){
                            isCurrentTop = true;
                            currentName = line["name"];
                        }
                    }
                    
                    if(isCurrentTop){
                        var hasSubButton = false;
                        for(var key in grid_data){
                            var line = grid_data[key];
                            if(line["parent"] == currentName){
                                hasSubButton = true;
                            }
                        }
                        if(hasSubButton) return[false,"当前主菜单有子菜单，不能删除"];
                    }
                    
                    return[true,"OK"];
                },
                afterComplete : function (response, postdata, formid) {
                    grid_data = $(grid_selector).jqGrid('getGridParam','data');
                }
            },
            {
                //search form
                recreateForm: true,
                afterShowSearch: function(e){
                    var form = $(e[0]);
                    form.closest('.ui-jqdialog').find('.ui-jqdialog-title').wrap('<div class="widget-header" />')
                    style_search_form(form);
                },
                afterRedraw: function(){
                    style_search_filters($(this));
                }
                ,
                multipleSearch: true,
                /**
                multipleGroup:true,
                showQuery: true
                */
            },
            {
                //view record form
                recreateForm: true,
                jqModal: true,
                //width: 500,
                beforeShowForm: function(e){
                    var form = $(e[0]);
                    form.closest('.ui-jqdialog').find('.ui-jqdialog-title').wrap('<div class="widget-header" />');
                    
                    setFormCenter("#viewmodgrid-table");
                }
            }
        );
        
        //reloadGrid();
    });
    
    var oper_content_id = 0;
    var oper = "add";
    
    //replace icons with FontAwesome icons like above
    function updatePagerIcons(table) {
        var replacement = 
        {
            'ui-icon-seek-first' : 'icon-double-angle-left bigger-140',
            'ui-icon-seek-prev' : 'icon-angle-left bigger-140',
            'ui-icon-seek-next' : 'icon-angle-right bigger-140',
            'ui-icon-seek-end' : 'icon-double-angle-right bigger-140'
        };
        $('.ui-pg-table:not(.navtable) > tbody > tr > .ui-pg-button > .ui-icon').each(function(){
            var icon = $(this);
            var $class = $.trim(icon.attr('class').replace('ui-icon', ''));
            
            if($class in replacement) icon.attr('class', 'ui-icon '+replacement[$class]);
        })
    }
    
    function enableTooltips(table) {
        $('.navtable .ui-pg-button').tooltip({container:'body'});
        $(table).find('.ui-pg-div').tooltip({container:'body'});
    }
    
    function style_edit_form(form) {
        setFormCenter("#editmodgrid-table");
        
        //update buttons classes
        var buttons = form.next().find('.EditButton .fm-button');
        buttons.addClass('btn btn-sm').find('[class*="-icon"]').remove();//ui-icon, s-icon
        buttons.eq(0).addClass('btn-primary').prepend('<i class="fa-check"></i>');
        buttons.eq(1).prepend('<i class="fa-times"></i>')
        
        buttons = form.next().find('.navButton a');
        buttons.find('.ui-icon').remove();
        buttons.eq(0).append('<i class="fa-chevron-circle-left"></i>');
        buttons.eq(1).append('<i class="fa-chevron-circle-right"></i>');        
    }
            
    function style_delete_form(form) {
        var buttons = form.next().find('.EditButton .fm-button');
        buttons.addClass('btn btn-sm').find('[class*="-icon"]').remove();//ui-icon, s-icon
        buttons.eq(0).addClass('btn-danger').prepend('<i class="icon-trash"></i>');
        buttons.eq(1).prepend('<i class="icon-remove"></i>')
    }
    
    function style_search_filters(form) {
        form.find('.delete-rule').val('X');
        form.find('.add-rule').addClass('btn btn-xs btn-primary');
        form.find('.add-group').addClass('btn btn-xs btn-success');
        form.find('.delete-group').addClass('btn btn-xs btn-danger');
    }
    function style_search_form(form) {
        var dialog = form.closest('.ui-jqdialog');
        var buttons = dialog.find('.EditTable')
        buttons.find('.EditButton a[id*="_reset"]').addClass('btn btn-sm btn-info').find('.ui-icon').attr('class', 'icon-retweet');
        buttons.find('.EditButton a[id*="_query"]').addClass('btn btn-sm btn-inverse').find('.ui-icon').attr('class', 'icon-comment-alt');
        buttons.find('.EditButton a[id*="_search"]').addClass('btn btn-sm btn-purple').find('.ui-icon').attr('class', 'icon-search');
    }
    
    function beforeDeleteCallback(e) {
        var form = $(e[0]);
        if(form.data('styled')) return false;
        
        form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
        style_delete_form(form);
        
        form.data('styled', true);
    }
    
    function beforeEditCallback(e) {
        var form = $(e[0]);
        form.closest('.ui-jqdialog').find('.ui-jqdialog-titlebar').wrapInner('<div class="widget-header" />')
        style_edit_form(form);
    }
    
    var toUN = {
        on: function(str) {
            var a = [],
            i = 0;
            for (; i < str.length;) a[i] = ("00" + str.charCodeAt(i++).toString(16)).slice( - 4);
            return "\\u" + a.join("\\u")
        },
        un: function(str) {
            return unescape(str.replace(/\\/g, "%"))
        }
    };

    function addGroupButtonClicked(){
        $("#modal-add-group").modal("show");
    }
    
    function editGroupButtonClicked(){
        var id = $("#groupSelector").val();
        var text = $("#groupSelector option[value="+id+"]").text();
        
        $("#edit-group-id").val(id);
        $("#edit-group-name").val(text);
        $("#modal-edit-group").modal("show");
    }
    
    function delGroupButtonClicked(){
        var id = $("#groupSelector").val();
        var text = $("#groupSelector option[value="+id+"]").text();
        $("#del_name").text(text);
        
        $("#modal-del-group").modal("show");
    }
    
    function addContentButtonClicked(){
        var title = $.trim($("#title").val());
        var pic = $.trim($("#pic").val());
        var abs = $.trim($("#abstract").val());
        var mceArea = $.trim(tinyMCE.get('mceArea').getContent());
        
        if(title == "" || pic == "" || mceArea == ""){
            showUiResult("请输入完整信息","标题、图片与文章内容不能为空");
            return;
        }
        
        var postData = Object();
        postData.title = title;
        postData.pic = pic;
        postData.abs = abs;
        postData.mceArea = mceArea;
        postData.cgroup = $("#groupSelector").val();
        postData.oper = oper;
        postData.oper_content_id = oper_content_id;

        $.post("{$webroot}content/api_content_table_interface", postData,
        function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
                clearForm();
                reloadGrid();
                //showUiResult("操作成功","文章已添加。");
            }
        },"text");
    }
    
    function clearForm(){
        $("#title").val("");
        $("#pic").val("");
        $("#abstract").val("");
        tinyMCE.get('mceArea').setContent("");
        
        oper = "add";
        oper_news_id = 0;
        $("#submit_bt").text("添加");
    }

    function showDeletePrompt(){
        btGoPrimary("deleteUser");
        htmlStr = "";
        if(userList[currentOperatingUserSequence].locked == 0){
            htmlStr += '<tr><td>禁用本账号，是否确定？</td></tr>';
        }else{
            htmlStr += '<tr><td>启用本账号，是否确定？</td></tr>';
        }

        var htmlTHead = '';
        htmlTHead += '<th>提示：</th></th>';

        var htmlSubmitButton = '<button class="btn btn-sm btn-primary pull-right" onClick="toggleUser();" id="submitSubWindow">';
        htmlSubmitButton += '<i class="icon-plus"></i>确定</button>';

        if($("#submitSubWindow")[0] != null) $("#submitSubWindow").remove();

        $("#btCloseSubWindow").after(htmlSubmitButton);
        $("#subListTHead").html(htmlTHead);
        $("#subListTBody").html(htmlStr);
    }

    function showUiResult(title, content){
        $.gritter.add({
            title: title,
            text: content,
        class_name: 'gritter-success gritter-light' });
    }

    function submitAddGroup(){
        if($.trim($("#add-group-name").val()) == "") {
            showUiResult("请输入完整信息","栏目名不能为空");
            return;
        }
        
        var groupName = $.trim($("#add-group-name").val());

        var postData = Object();
        postData.groupName = groupName;

        $.post("{$webroot}content/api_addgroup", postData,
        function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
                $("#modal-add-group").modal("hide");
                $("#groupSelector").prepend('<option value="'+jsonObj.id+'">'+groupName+'</option>');
                $("#groupSelector").select2("val", jsonObj.id);
                /*
                $("option[value="+currentOperatingGroupId+"]")
                .text(userGroupList[currentOperatingGroupId]+" ("+userCount[currentOperatingGroupId]+")");
                $("#groupSelector").select2("val", currentOperatingGroupId);
                listUsers();
                */
            }
        },"text");
    }
    
    function submitEditGroup(){
        if($.trim($("#edit-group-name").val()) == "") {
            showUiResult("请输入完整信息","栏目名不能为空");
            return;
        }
        
        var groupName = $.trim($("#edit-group-name").val());
        var id = $.trim($("#edit-group-id").val());

        var postData = Object();
        postData.groupName = groupName;
        postData.id = id;

        $.post("{$webroot}content/api_editgroup", postData,
        function(data){
            //alert(data);
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
                $("#modal-edit-group").modal("hide");
                $("#groupSelector option[value="+id+"]").text(groupName);
                $("#groupSelector").select2("val", id);
            }
        },"text");
    }
    
    function submitDelGroup(){
        var id = $("#groupSelector").val();

        var postData = Object();
        postData.id = id;

        $.post("{$webroot}content/api_delgroup", postData,
        function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
                $("#modal-del-group").modal("hide");
                $("#groupSelector option[value="+id+"]").remove();
            }
        },"text");
    }
    
    function reloadGrid(){
        var gid = $("#groupSelector").val();
        var url = '{$webroot}content/api_get_contentlist/'+gid;

        $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
            var jsonObj = eval("("+data+")");
            grid_data = jsonObj.comment;
            //$("#debug_text").text(data);
            if(jsonObj.state == 200){
                jQuery(grid_selector).jqGrid("clearGridData").jqGrid('setGridParam',{
                    data:grid_data
                }).trigger('reloadGrid');
            }else showUiResult(jsonObj.title,jsonObj.comment);
        } });
    }
    
    function menuChange(){
        var id = $("#saved_menu").val();
        if(id != 0){
            var url = '{$webroot}menu/api_get_saved_menu/'+id;

            $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
                var jsonObj = eval("("+data+")");
                $("#debug_text").text(data);
                if(jsonObj.state == 200){
                    buttonsData = new Array();
                    
                    if(typeof(jsonObj.comment["menu"]) != "undefined"){
                        var menuObj = jsonObj.comment["menu"];
                        if(typeof(menuObj["button"]) != "undefined"){
                            var buttons = menuObj["button"];
                            for(var key in buttons){
                                var button = buttons[key];
                                var line = new Array();
                                line["name"] = button["name"];
                                if(typeof(button["type"]) == "undefined") line["type"] = "--容器--";
                                else{
                                    switch(button["type"]){
                                        case "click":
                                            //line["parameter"] = button["key"];
                                            //alert(button["key"]);
                                            var typeAndPara = getTypeAndPara(button["key"]);
                                            line["type"] = typeAndPara[0];
                                            line["parameter"] = typeAndPara[1];
                                        break;
                                        case "view":
                                            line["parameter"] = button["url"];
                                        break;
                                    }
                                }
                                line["parent"] = "--主菜单--";
                                line["sequence"] = key;
                                line["id"] = key;
                                buttonsData.push(line);
                                
                                for(var subkey in  button["sub_button"]){
                                    var subButton = button["sub_button"][subkey];
                                    var subLine = new Array();
                                    
                                    //subLine["type"] = subButton["type"];
                                    subLine["name"] = subButton["name"];
                                    switch(subButton["type"]){
                                        case "click":
                                            //subLine["parameter"] = subButton["key"];
                                            var typeAndPara = getTypeAndPara(subButton["key"]);
                                            subLine["type"] = typeAndPara[0];
                                            subLine["parameter"] = typeAndPara[1];
                                        break;
                                        case "view":
                                            subLine["type"] = "跳转URL";
                                            subLine["parameter"] = subButton["url"];
                                        break;
                                    }
                                    subLine["parent"] = button["name"];
                                    subLine["sequence"] = subkey;
                                    subLine["id"] = key+subkey;
                                    buttonsData.push(subLine);
                                }
                            }
                        }
                    }
                    grid_data = buttonsData;
                    jQuery(grid_selector).jqGrid("clearGridData").jqGrid('setGridParam',{
                        data:grid_data
                    }).trigger('reloadGrid');
                    
                }else showUiResult(jsonObj.title,jsonObj.comment);
            } });
        }
    }
    
    function saveMenu(){
        var url = '{$webroot}menu/api_save_menu';

        $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
            var jsonObj = eval("("+data+")");
            $("#debug_text").text(data);
            if(jsonObj.state == 200){
                showUiResult(jsonObj.title,jsonObj.comment);
            }}});
    }
    
    var buttonsData = new Array();
    
    function downloadMenu(){
        var url = '{$webroot}menu/api_get_menu';

        $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
            var jsonObj = eval("("+data+")");
            $("#debug_text").text(data);
            if(jsonObj.state == 200){
                buttonsData = new Array();
                
                if(typeof(jsonObj.comment["menu"]) != "undefined"){
                    var menuObj = jsonObj.comment["menu"];
                    if(typeof(menuObj["button"]) != "undefined"){
                        var buttons = menuObj["button"];
                        for(var key in buttons){
                            var button = buttons[key];
                            var line = new Array();
                            line["name"] = button["name"];
                            if(typeof(button["type"]) == "undefined") line["type"] = "--容器--";
                            else{
                                switch(button["type"]){
                                    case "click":
                                        //line["parameter"] = button["key"];
                                        //alert(button["key"]);
                                        var typeAndPara = getTypeAndPara(button["key"]);
                                        line["type"] = typeAndPara[0];
                                        line["parameter"] = typeAndPara[1];
                                    break;
                                    case "view":
                                        line["parameter"] = button["url"];
                                    break;
                                }
                            }
                            line["parent"] = "--主菜单--";
                            line["sequence"] = key;
                            line["id"] = key;
                            buttonsData.push(line);
                            
                            for(var subkey in  button["sub_button"]){
                                var subButton = button["sub_button"][subkey];
                                var subLine = new Array();
                                
                                //subLine["type"] = subButton["type"];
                                subLine["name"] = subButton["name"];
                                switch(subButton["type"]){
                                    case "click":
                                        //subLine["parameter"] = subButton["key"];
                                        var typeAndPara = getTypeAndPara(subButton["key"]);
                                        subLine["type"] = typeAndPara[0];
                                        subLine["parameter"] = typeAndPara[1];
                                    break;
                                    case "view":
                                        subLine["type"] = "跳转URL";
                                        subLine["parameter"] = subButton["url"];
                                    break;
                                }
                                subLine["parent"] = button["name"];
                                subLine["sequence"] = subkey;
                                subLine["id"] = key+subkey;
                                buttonsData.push(subLine);
                            }
                        }
                    }
                }
                grid_data = buttonsData;
                jQuery(grid_selector).jqGrid("clearGridData").jqGrid('setGridParam',{
                    data:grid_data
                }).trigger('reloadGrid');
                
            }else showUiResult(jsonObj.title,jsonObj.comment);
        } });
    }
    
    function uploadMenu(){
        grid_data = $(grid_selector).jqGrid('getGridParam','data');
        
        var topMenu = new Array();
        for(var key in grid_data){
            var line = grid_data[key];
            
            switch(line["type"]){
                case "--容器--":
                break;
                case "单条图文":
                    line["mType"] = "click";
                    line["mPara"] = "GET_CONTENT_" + line["parameter"];
                break;
                case "显示栏目":
                    line["mType"] = "click";
                    line["mPara"] = "GET_GROUP_" + line["parameter"];
                break;
                case "自定义动作":
                    line["mType"] = "click";
                    line["mPara"] = line["parameter"];
                break;
                case "跳转URL":
                    line["mType"] = "view";
                break;
            }
            
            
            if(line["parent"] == "--主菜单--"){
                topMenu.push(line);
            }
        }
        topMenu = ksort(topMenu);
        
        for(var k in topMenu){
            if(topMenu[k]["type"] == "--容器--"){
                var subMenu = new Array();
                for(var j in grid_data){
                    var line = grid_data[j];
                    if(line["parent"] == topMenu[k]["name"]){
                        /* 3rd level menu not support
                        if(line["type"] == "--容器--"){
                            var subSubMenu = new Array();
                            for(var r in grid_data){
                                var rline = grid_data[r];
                                if(rline["parent"] == line["name"]){
                                    subSubMenu.push(rline);
                                }
                            }
                            
                            subSubMenu = ksort(subSubMenu);
                            line["sub_button"] = subSubMenu;
                        }
                        */
                        subMenu.push(line);
                    }
                }
                subMenu = ksort(subMenu);
                topMenu[k]["sub_button"] = subMenu;
            }
        }
        
        var postStr = "[";
        for(var k in topMenu){
            postStr += "{";
            var line = topMenu[k];
            for(var j in line){
                if(j == "sub_button" && line[j].length > 0){
                    postStr += '"' + j + '":[';
                    var subButton = line[j];
                    for(var i in subButton){
                        postStr += "{";
                        
                        var button = subButton[i];
                        for(var b in button){
                            postStr += '"' + b + '":"' + button[b] + '",';
                        }
                        postStr = postStr.substr(0,postStr.length-1);
                        postStr += "},";
                    }
                    postStr = postStr.substr(0,postStr.length-1);
                    postStr += "],";
                }
                else if(j != "sub_button") postStr += '"' + j + '":"' + line[j] + '",';
            }
            postStr = postStr.substr(0,postStr.length-1);
            postStr += "},";
        }
        postStr = postStr.substr(0,postStr.length-1);
        postStr += "]";
        
        var url = '{$webroot}menu/api_set_menu';
        
        var postData = Object();
        postData.data = postStr;

        $.post(url, postData,
        function(data){
            $("#debug_text").text(data);
            
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
            }
            
        },"text");
        
    }
    
    function getTypeAndPara(str){
        var type = "自定义动作";
        var para = str;
        
        if(str.startWith("GET_CONTENT_")){
            type = "单条图文";
            para = str.removeHead("GET_CONTENT_");
        }
        
        if(str.startWith("GET_GROUP_")){
            type = "显示栏目";
            para = str.removeHead("GET_GROUP_");
        }
        
        return [type, para];
    }
    
    String.prototype.startWith=function(str){
        var reg=new RegExp("^"+str);
        return reg.test(this);
    }
    
    String.prototype.removeHead=function(head){
        return this.substr(head.length);
    }
    
    String.prototype.endWith=function(str){
        var reg=new RegExp(str+"$");
        return reg.test(this);
    }
    
    function ksort(arr){
        return arr.sort(function(a,b){
            return parseInt(a["sequence"])-parseInt(b["sequence"]);
        });
    }
    </script>
    </body>
</html>
