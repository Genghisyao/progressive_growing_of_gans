<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <title> 管控平台-推荐用户管理 </title>

            <meta name="description" content="Minimal empty page" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />

            <!-- basic styles -->

            <link href="{$webroot}assets/css/bootstrap.min.css" rel="stylesheet" />
            <link rel="stylesheet" href="{$webroot}assets/css/font-awesome.min.css" />
            <!--[if IE 7]>
            <link rel="stylesheet" href="{$webroot}assets/css/font-awesome-ie7.min.css" />
            <![endif]-->

            <!-- page specific plugin styles -->
            <link rel="stylesheet" href="{$webroot}assets/css/jquery-ui-1.10.3.custom.min.css" />
            <link rel="stylesheet" href="{$webroot}assets/css/jquery.gritter.css" />
            <link rel="stylesheet" href="{$webroot}assets/css/select2.css" />
            <link rel="stylesheet" href="{$webroot}assets/css/chosen.css" />

            <!-- fonts -->

            <link rel="stylesheet" href="{$webroot}assets/css/ace-fonts.css" />

            <!-- ace styles -->

            <link rel="stylesheet" href="{$webroot}assets/css/ace.min.css" />
            <link rel="stylesheet" href="{$webroot}assets/css/ace-rtl.min.css" />
            <link rel="stylesheet" href="{$webroot}assets/css/ace-skins.min.css" />

            <!--[if lte IE 8]>
            <link rel="stylesheet" href="{$webroot}assets/css/ace-ie.min.css" />
            <![endif]-->

            <!-- inline styles related to this page -->

            <!-- ace settings handler -->

            <!--script src="{$webroot}assets/js/ace-extra.min.js"></script-->
            <script src="{$webroot}assets/js/uncompressed/ace-extra.js"></script>

            <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->

            <!--[if lt IE 9]>
            <script src="{$webroot}assets/js/html5shiv.js"></script>
            <script src="{$webroot}assets/js/respond.min.js"></script>
            <![endif]-->
        </head>

        <body>
            <include file="./Tpl/header.html" />

                <div class="main-container" id="main-container">
                    <script type="text/javascript">
                        try{ace.settings.check('main-container' , 'fixed')}catch(e){}
                    </script>

                    <div class="main-container-inner">
                        <include file="./Tpl/sidebar.html" />

                            <div class="main-content">

                                <div class="breadcrumbs" id="breadcrumbs">
                                    <script type="text/javascript">
                                        try{ace.settings.check('breadcrumbs' , 'fixed')}catch(e){}
                                    </script>

                                    <ul class="breadcrumb">
                                        <li>
                                            <i class="icon-home home-icon"></i>
                                            <a href="#">首页</a>
                                        </li>
                                        <li class="active">推荐用户管理</li>
                                        </ul><!-- .breadcrumb -->

                                        <div class="nav-search" id="nav-search">
                                            <form class="form-search">
                                                <span class="input-icon">
                                                    <input type="text" placeholder="搜索 ..." class="nav-search-input" id="nav-search-input" autocomplete="off" />
                                                    <i class="icon-search nav-search-icon"></i>
                                                </span>
                                            </form>
                                        </div><!-- #nav-search -->
                                    </div>

                                    <div class="page-content">
                                        <div class="page-header">
                                            <h1>
                                                <small>
                                                    选择用户组: &nbsp;&nbsp;&nbsp;
                                                    <select id="userGroupSelector" style="width:200px">
                                                        <php>
                                                            foreach($groups as $key => $value){
                                                              echo '<optgroup label="'.$key.'">';
                                                                foreach($value as $v){
                                                                  echo '<option value="'.$v[0].'">'.$v[1].'</option>';
                                                                }
                                                              echo '</optgroup>';
                                                            }
                                                        </php>
                                                </select>
                                                
                                                <button class="btn btn-xs btn-info" type="button" onClick="addUserButtonClicked();">
                                                        <i class="icon-plus bigger-110"></i>
                                                        增加<span id="newUserButtonText"></span>
                                                    </button>
                                                    
                                                </small>
                                            </h1>
                                            
                                        </div><!-- /.page-header -->

                                        <div class="row">
                                            <div class="col-xs-12">
                                                <!-- PAGE CONTENT BEGINS -->

                                                <div class="row">
                                                    <div class="col-xs-12">
                                                        <div class="table-responsive">
                                                            <table id="sample-table-1" class="table table-striped table-bordered table-hover">
                                                                <thead>
                                                                    <tr>
                                                                        <!--th class="center">
                                                                        <label>
                                                                        <input type="checkbox" class="ace" />
                                                                        <span class="lbl"></span>
                                                                        </label>
                                                                        </th-->
                                                                        <th> 手机号码 </th>
                                                                        <th> 姓名 </th>
                                                                        <th> 邮箱 </th>
                                                                        <th class="hidden-480"> 加入日期 </th>
                                                                        <th> 通道单价 </th>
                                                                        <th> 余额 (元) </th>
                                                                         <th class="hidden-480"> 状态 </th>
                                                                         <th> </th>
                                                                        </tr>
                                                                    </thead>

                                                                    <tbody id="groupListTBody">

                                                                    </tbody>
                                                                </table>
                                                            </div><!-- /.table-responsive -->
                                                        </div><!-- /span -->
                                                    </div><!-- /row -->


                                                    <div id="modal-add-user-admin" class="modal fade" tabindex="-1">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header no-padding">
                                                                    <div class="table-header">
                                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                                            <span class="white">&times;</span>
                                                                        </button>
                                                                        增加 <span id="newUserBannerText"></span>
                                                                        初始密码为 888888
                                                                    </div>
                                                                </div>

                                                                <div class="modal-body no-padding">
                                                                    <table class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                                        <thead>
                                                                            <tr>
                                                                                <th> 手机号码: </th>
                                                                                <th> 姓名: </th>
                                                                            </tr>
                                                                        </thead>

                                                                        <tbody>
                                                                            <tr>
                                                                                <td width="50%">
                                                                                    <input type="text" id="add-user-phone" placeholder="手机号码作为登录名" class="col-xs-12 col-sm-12">
                                                                                </td>
                                                                                <td width="50%">
                                                                                    <input type="text" id="add-user-realname" placeholder="真实姓名" class="col-xs-12 col-sm-12">
                                                                                </td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>

                                                                <div class="modal-footer no-margin-top">
                                                                    <button class="btn btn-sm btn-danger pull-left" data-dismiss="modal">
                                                                        <i class="icon-remove"></i>
                                                                        关闭
                                                                    </button>

                                                                    <button class="btn btn-sm btn-primary pull-right" onClick="submitAddUser();">
                                                                        <i class="icon-plus"></i>
                                                                        提交
                                                                    </button>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->
                                                    </div>
                                                    
                                                    <div id="modal-add-user-customer" class="modal fade" tabindex="-1">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header no-padding">
                                                                    <div class="table-header">
                                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                                            <span class="white">&times;</span>
                                                                        </button>
                                                                        增加 <span id="newCustomerBannerText"></span>
                                                                        初始密码为 888888
                                                                    </div>
                                                                </div>

                                                                <div class="modal-body no-padding">
                                                                    <table class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                                        <thead>
                                                                            <tr>
                                                                                <th> 登录名: </th>
                                                                                <th> 发射机号码: </th>
                                                                            </tr>
                                                                        </thead>

                                                                        <tbody>
                                                                            <tr>
                                                                                <td width="50%">
                                                                                    <input type="text" id="add-customer-phone" placeholder="手机号码" class="col-xs-12 col-sm-12">
                                                                                </td>
                                                                                <td width="50%">
                                                                                    <input type="text" id="add-customer-boxid" placeholder="发射机号码" class="col-xs-12 col-sm-12">
                                                                                </td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>

                                                                <div class="modal-footer no-margin-top">
                                                                    <button class="btn btn-sm btn-danger pull-left" data-dismiss="modal">
                                                                        <i class="icon-remove"></i>
                                                                        关闭
                                                                    </button>

                                                                    <button class="btn btn-sm btn-primary pull-right" onClick="submitAddCustomer();">
                                                                        <i class="icon-plus"></i>
                                                                        提交
                                                                    </button>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->
                                                    </div>

                                                    <div id="modal-operate-singleuser" class="modal fade" tabindex="-1">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header no-padding">
                                                                    <div class="table-header">
                                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                                                            <span class="white">&times;</span>
                                                                        </button>
                                                                        设置用户
                                                                    </div>
                                                                </div>

                                                                <div class="modal-body no-padding">
                                                                    <table class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                                        <thead>
                                                                            <tr>
                                                                                <th colspan="4"> 用户: <span id="operatingUserName"></span></th>
                                                                            </tr>
                                                                        </thead>

                                                                        <tbody>
                                                                            <tr>
                                                                                <td>
                                                                                    <button class="btn btn-primary btn-block" id="btResetPassword" onClick="resetPassword();"> 
                                                                                        重设密码</button>
                                                                                </td>
                                                                                <td>
                                                                                <button class="btn btn-primary btn-block" id="btCharge" onClick="charge();"> 充值 </button>
                                                                                </td>
                                                                                <td>
                                                                                    <button class="btn btn-primary btn-block" id="btConfigGroup" onClick="setGroup();"> 组别设置</button>
                                                                                </td>
                                                                                <td>
                                                                                    <button class="btn btn-primary btn-block" id="deleteUser" onClick="showDeletePrompt();"> 删除</button>
                                                                                </td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>

                                                                    <table class="table table-striped table-bordered table-hover no-margin-bottom no-border-top">
                                                                        <thead>
                                                                            <tr id="subListTHead">
                                                                            </tr>
                                                                        </thead>

                                                                        <tbody id="subListTBody">
                                                                        </tbody>
                                                                    </table>
                                                                </div>

                                                                <div class="modal-footer no-margin-top">
                                                                    <button class="btn btn-sm btn-danger pull-left" data-dismiss="modal" id="btCloseSubWindow">
                                                                        <i class="icon-remove"></i>
                                                                        关闭
                                                                    </button>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->
                                                    </div>

                                                    <!-- PAGE CONTENT ENDS -->
                                                </div><!-- /.col -->
                                            </div><!-- /.row -->

                                            <!-- hr />
                                            <div class="well">
                                                <h4 class="green smaller lighter">Debug</h4>
                                                <p id="debug_text"></p>
                                            </div -->

                                        </div><!-- /.page-content -->
                                    </div><!-- /.main-content -->

                                </div><!-- /.main-container-inner -->
                            </div><!-- /.main-container -->

                            <!-- basic scripts -->

                            <!--[if !IE]> -->

                            <script type="text/javascript">
                                window.jQuery || document.write("<script src='{$webroot}assets/js/jquery-2.0.3.min.js'>"+"<"+"/script>");
                            </script>

                            <!-- <![endif]-->

                            <!--[if IE]>
                            <script type="text/javascript">
                            window.jQuery || document.write("<script src='{$webroot}assets/js/jquery-1.10.2.min.js'>"+"<"+"/script>");
                            </script>
                            <![endif]-->

<script type="text/javascript">
    if("ontouchend" in document) document.write("<script src='{$webroot}assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
</script>
<script src="{$webroot}assets/js/bootstrap.min.js"></script>
<script src="{$webroot}assets/js/typeahead-bs2.min.js"></script>

<!-- page specific plugin scripts -->
<script src="{$webroot}assets/js/jquery.gritter.min.js"></script>
<script src="{$webroot}assets/js/select2.min.js"></script>
<script src="{$webroot}assets/js/chosen.jquery.min.js"></script>

<!-- ace scripts -->

<script src="{$webroot}assets/js/ace-elements.min.js"></script>
<script src="{$webroot}assets/js/ace.min.js"></script>

<!-- inline scripts related to this page -->
<script>
    var userGroupList = [];
    var userCount = [];
    var groupType = [];
    var groupTypeName = [];
    var userList = [];
    var currentOperatingUserId = -1;
    var currentOperatingUserSequence = -1;
    var currentOperatingGroupId = -1;

    <?php
    foreach($groups as $key => $value){
        foreach($value as $v){
            echo 'userGroupList['.$v[0].']="'.$v[1].'";';
            echo 'userCount['.$v[0].']="'.$v[2].'";';
            echo 'groupType['.$v[0].']="'.$v[3].'";';
            echo 'groupTypeName['.$v[0].']="'.$key.'";';
        }
    }
    ?>

    jQuery(document).ready(function(){
        /*
        var body = $(document.body);
        body.removeClass('skin-1 skin-2 skin-3');
        skin_class = 'skin-1';
        if(skin_class != 'default') body.addClass(skin_class);
        if(skin_class == 'skin-1') {
            $('.ace-nav > li.grey').addClass('dark');
        }

        ace.settings.sidebar_fixed(true);
        ace.settings.breadcrumbs_fixed(true);
        */
        
        listUsers();
        updateHeader();

        $("#userGroupSelector").select2({width:"off"});
        $("#userGroupSelector").on("change", function(e) {listUsers(); });
    });
    
    var toUN = {
        on: function(str) {
            var a = [],
            i = 0;
            for (; i < str.length;) a[i] = ("00" + str.charCodeAt(i++).toString(16)).slice( - 4);
            return "\\u" + a.join("\\u")
        },
        un: function(str) {
            return unescape(str.replace(/\\/g, "%"))
        }
    };

    function addUserButtonClicked(){
        if(groupType[currentOperatingGroupId] < 3){
            $("#modal-add-user-admin").modal("show");
        }else{
            $("#modal-add-user-customer").modal("show");
        }
    }

    function operateDataLine(userId){
        currentOperatingUserId = userList[userId].id;
        currentOperatingUserSequence = userId;
        if(userList[userId].locked == "0"){
            $("#deleteUser").text("禁用");
        }else{
            $("#deleteUser").text("恢复");
        }
        $("#operatingUserName").text(userGroupList[currentOperatingGroupId]+" "+userList[userId].nickname);
        $("#modal-operate-singleuser").modal("show");
        charge();
    }

    function btGoPrimary(_curId){
        var buttons = ["btResetPassword","btCharge","btConfigGroup","deleteUser"];
        for(var key in buttons){
            if(buttons[key] != _curId){ $("#"+buttons[key]).removeClass("btn-default");
                $("#"+buttons[key]).addClass("btn-primary");
            }else{
                $("#"+buttons[key]).removeClass("btn-primary");
                $("#"+buttons[key]).addClass("btn-default");
            }
        }
    }

    function listUsers(){  // using
        currentOperatingGroupId = $("#userGroupSelector").val();
        $("#newUserButtonText").text(userGroupList[currentOperatingGroupId]);
        $("#newUserBannerText").text(userGroupList[currentOperatingGroupId]);
        $("#newCustomerBannerText").text(userGroupList[currentOperatingGroupId]);
        var url = '{$webroot}user/api_getcommend_list/'+currentOperatingGroupId;
        $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
            var jsonObj = eval("("+data+")");
            $("#debug_text").text(data);
            
            if(jsonObj.state == 200){
                userList = jsonObj.userList;
                var htmlStr = '';
                for(var key in userList){
                    htmlStr += '<tr>';
                    //htmlStr += '<td class="center"><label><input type="checkbox" class="ace" /><span class="lbl"></span></label></td>';
                    htmlStr += '<td>'+userList[key].phone+'</td>';
                    if(userList[key].nickname == null) htmlStr += '<td>空</td>';
                    else htmlStr += '<td>'+userList[key].nickname+'</td>';
                    if(userList[key].email == null) htmlStr += '<td>空</td>';
                    else htmlStr += '<td>'+userList[key].email+'</td>';
                    htmlStr += '<td>'+userList[key].create_date+'</td>';
                    
                    htmlStr += '<td>'+userList[key].sms_price+'</td>';
                    htmlStr += '<td>'+userList[key].sms_account+'</td>';
                    
                    if(userList[key].locked == 0) htmlStr += '<td class="hidden-480"><span class="label label-lg label-success">正常</span></td>';
                    if(userList[key].locked == 1) htmlStr += '<td class="hidden-480"><span class="label label-lg label-warning">禁用</span></td>';
                    htmlStr += '<td><button class="btn btn-xs btn-info btn-block" type="button" onClick="operateDataLine('+key+');">操作</button></td>';
                    htmlStr += '</tr>';
                }
                
                $("#groupListTBody").html(htmlStr);
            }else showUiResult(jsonObj.title,jsonObj.comment);
        } });
    }
    
    
    function charge(){
        btGoPrimary("btCharge");
        var htmlStr = '';
        htmlStr += '<tr><td><input type="text" id="input-charge" />';
        htmlStr += '</td></tr>';

        var htmlTHead = '';
        htmlTHead += '<th>请填写充值金额 (元)：</th></th>';

        var htmlSubmitButton = '<button class="btn btn-sm btn-primary pull-right" onClick="goCharge();" \
        id="submitSubWindow">';
        htmlSubmitButton += '<i class="icon-plus"></i>确定</button>';if($("#submitSubWindow")[0] != null) $("#submitSubWindow").remove();

        $("#btCloseSubWindow").after(htmlSubmitButton);
        $("#subListTHead").html(htmlTHead);
        $("#subListTBody").html(htmlStr);
    }

    function setGroup(){
        btGoPrimary("btConfigGroup");
        var htmlStr = '';
        htmlStr += '<tr><td><select class="chosen-select" id="changeUserGroupSelector" data-placeholder="请选择用户组...">';
        var groupTypeStr = "";
        for(var key in groupType){
            var newGroup = false;
            if(groupTypeName[key] != groupTypeStr) {
                newGroup = true;
                groupTypeStr = groupTypeName[key];
                if(groupTypeName[key] != "") htmlStr += '</optgroup>';
            }
            if(newGroup == true) htmlStr += '<optgroup label="'+groupTypeStr+'">';
            htmlStr += '<option value="'+key+'">'+userGroupList[key]+'</option>';
        }
        htmlStr += '</optgroup>';
        htmlStr += '</select></td></tr>';

        var htmlTHead = '';
        htmlTHead += '<th>请选择用户组：</th></th>';

        var htmlSubmitButton = '<button class="btn btn-sm btn-primary pull-right" onClick="goSetGroup();" id="submitSubWindow">';
        htmlSubmitButton += '<i class="icon-plus"></i>确定</button>';if($("#submitSubWindow")[0] != null) $("#submitSubWindow").remove();

        $("#btCloseSubWindow").after(htmlSubmitButton);
        $("#subListTHead").html(htmlTHead);
        $("#subListTBody").html(htmlStr);
        $("#changeUserGroupSelector").chosen({no_results_text:"没有用户组",width:"200px"});
    }

    function goSetGroup(){
        var targetGroupId = $("#changeUserGroupSelector").val();
        var url = '{$webroot}user/api_change_usergroup/'+currentOperatingUserId+'/'+targetGroupId;
        $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
                $("#modal-operate-singleuser").modal("hide");
                userCount[currentOperatingGroupId] --;
                userCount[targetGroupId] ++;
                /*
                $("#userGroupSelector option[value="+targetGroupId+"]")
                .text(userGroupList[targetGroupId]+" ("+userCount[targetGroupId]+")");

                $("#userGroupSelector option[value="+currentOperatingGroupId+"]")
                .text(userGroupList[currentOperatingGroupId]+" ("+userCount[currentOperatingGroupId]+")");
                $("#userGroupSelector").select2("val", currentOperatingGroupId);
                */
                listUsers();
            }
            $("#debug_text").text(data);
        }});
    }
    
    function goCharge(){
        var money = $.trim($("#input-charge").val());
        if(!isFloat(money)){
            showUiResult("操作错误", "金额栏请输入数字.");
            return;
        }
        
        var postData = Object();
        postData.user = currentOperatingUserId;
        postData.money = money;

        $.post("{$webroot}user/api_money_transfer", postData,
        function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title, jsonObj.comment);
            if(jsonObj.state == 200){
                $("#modal-operate-singleuser").modal("hide");
                listUsers();
            }
            $("#debug_text").text(data);
        },"text");
    }

    function privilegeCheckChange(_inputObj){
        //alert(_inputObj.id+" "+_inputObj.value+" "+apiList[_inputObj.value].group_id);
        var currentValue = true;
        if(apiList[_inputObj.value].group_id == null) currentValue = false;
        var apiId = apiList[_inputObj.value].id;
        if(currentValue == _inputObj.checked){
            $("#switch-hint-"+apiId).text("");
        }else{
            $("#switch-hint-"+apiId).text("未提交");
        }
    }

    function submitApiPrivilegeSetting(){
        var add = "", del = "", hasChange = false;
        $("#subListTBody").find('tr > td input:checkbox')
        .each(function(){
            var currentValue = true;
            if(apiList[this.value].group_id == null) currentValue = false;
            var api_id = apiList[this.value].id;

            if(currentValue != this.checked){
                if(this.checked == true){
                    add += api_id + "|";
                }else{
                    del += api_id + "|";
                }
                hasChange = true;
            }
        });

        if(!hasChange) {
            showUiResult("操作结果","无修改需要提交。");
            return;
        }

        //alert("add: "+add+" del: "+del);
        var postData = Object();
        postData.groupId = currentOperatingGroupId;
        postData.add = add;
        postData.del = del;

        $.post("{$webroot}user/api_modify_privilege", postData,
        function(data){
            var jsonObj = eval("("+data+")");
            $("#debug_text").text(data);
            for(var key in jsonObj.add){
                $("#switch-hint-"+jsonObj.add[key]).text("增加成功");
                for(var k in apiList){
                    if(apiList[k].id == jsonObj.add[key]) apiList[k].group_id = currentOperatingGroupId;
                }
            }
            for(var key in jsonObj.del){
                $("#switch-hint-"+jsonObj.del[key]).text("删除成功");
                for(var k in apiList){
                    if(apiList[k].id == jsonObj.del[key]) apiList[k].group_id = null;
                }
            }

            showUiResult(jsonObj.title,jsonObj.comment);
        },"text");
    }

    function resetPassword(){
        btGoPrimary("btResetPassword");
        var htmlStr = '';
        htmlStr += '<tr><td>将用户密码设置为 888888，是否确定？</td></tr>';

        var htmlTHead = '';
        htmlTHead += '<th>提示：</th></th>';

        var htmlSubmitButton = '<button class="btn btn-sm btn-primary pull-right" onClick="goResetPassword();" id="submitSubWindow">';
        htmlSubmitButton += '<i class="icon-plus"></i>确定</button>';if($("#submitSubWindow")[0] != null) $("#submitSubWindow").remove();

        $("#btCloseSubWindow").after(htmlSubmitButton);
        $("#subListTHead").html(htmlTHead);
        $("#subListTBody").html(htmlStr);
    }

    function goResetPassword(){
        var userId = currentOperatingUserId;
        var url = '{$webroot}user/api_reset_user_psw/'+userId;
        $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            $("#debug_text").text(data);
        }});
    }

    function showDeletePrompt(){
        btGoPrimary("deleteUser");
        htmlStr = "";
        if(userList[currentOperatingUserSequence].locked == 0){
            htmlStr += '<tr><td>禁用本账号，是否确定？</td></tr>';
        }else{
            htmlStr += '<tr><td>启用本账号，是否确定？</td></tr>';
        }

        var htmlTHead = '';
        htmlTHead += '<th>提示：</th></th>';

        var htmlSubmitButton = '<button class="btn btn-sm btn-primary pull-right" onClick="toggleUser();" id="submitSubWindow">';
        htmlSubmitButton += '<i class="icon-plus"></i>确定</button>';

        if($("#submitSubWindow")[0] != null) $("#submitSubWindow").remove();

        $("#btCloseSubWindow").after(htmlSubmitButton);
        $("#subListTHead").html(htmlTHead);
        $("#subListTBody").html(htmlStr);
    }

    function toggleUser(){
        var url = '{$webroot}user/api_toggle_user/'+currentOperatingUserId;
        $.ajax({url:url,async:true,cache:false,dataType:"text", success:function(data){
            var jsonObj = eval("("+data+")");
            $("#modal-operate-singleuser").modal("hide");
            showUiResult(jsonObj.title,jsonObj.comment);
            $("#debug_text").text(data);
            listUsers();
        }});
    }

    function rebindCheckAllAction(){
        $('table th input:checkbox').on('click' , function(){
            var that = this;
            $(this).closest('table').find('tr > td:first-child input:checkbox')
            .each(function(){
                this.checked = that.checked;
                $(this).closest('tr').toggleClass('selected');
            });
        });
    }

    function showUiResult(title, content){
        $.gritter.add({
            title: title,
            text: content,
        class_name: 'gritter-success gritter-light' });
    }

    function submitAddUser(){
        if($("#add-user-phone").val() == "" || $.trim($("#add-user-realname").val()) == "") {
            showUiResult("请输入完整信息","手机号码与姓名不能为空");
            return;
        }

        if(!isPhoneNumber($("#add-user-phone").val())){
            showUiResult("请输入正确信息","手机号码不正确");
            return;
        }

        var postData = Object();
        postData.phone = $("#add-user-phone").val();
        postData.nickname = $.trim($("#add-user-realname").val());
        postData.groupId = currentOperatingGroupId;

        $.post("{$webroot}user/api_adduser", postData,
        function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
                $("#modal-add-user-admin").modal("hide");
                userCount[currentOperatingGroupId] ++;
                $("option[value="+currentOperatingGroupId+"]")
                .text(userGroupList[currentOperatingGroupId]+" ("+userCount[currentOperatingGroupId]+")");
                $("#userGroupSelector").select2("val", currentOperatingGroupId);
                listUsers();
            }
        },"text");
    }

    function submitAddCustomer(){
        if($("#add-customer-phone").val() == "" || $("#add-customer-boxid").val() == "") {
            showUiResult("请输入完整信息","手机号码与发射机号不能为空");
            return;
        }

        if(!isPhoneNumber($("#add-customer-phone").val()) || !isPhoneNumber($("#add-customer-boxid").val())){
            showUiResult("请输入正确信息","手机号码/发射机号码不正确");
            return;
        }

        var postData = Object();
        postData.phone = $("#add-customer-phone").val();
        postData.boxid = $("#add-customer-boxid").val();
        postData.groupId = currentOperatingGroupId;

        $.post("{$webroot}user/api_addcustomer", postData,
        function(data){
            var jsonObj = eval("("+data+")");
            showUiResult(jsonObj.title,jsonObj.comment);
            if(jsonObj.state == 200){
                $("#modal-add-user-customer").modal("hide");
                userCount[currentOperatingGroupId] ++;
                $("option[value="+currentOperatingGroupId+"]")
                .text(userGroupList[currentOperatingGroupId]+" ("+userCount[currentOperatingGroupId]+")");
                $("#userGroupSelector").select2("val", currentOperatingGroupId);
                listUsers();
            }
        },"text");
    }

    /**
    * email格式校验
    * @param {Object} email 邮件地址
    */
    function emailFormatCheck(email){
        if ((email.length > 128) || (email.length < 6)) {
            return false;
        }
        var format = /^[A-Za-z0-9+]+[A-Za-z0-9\.\_\-+]*@([A-Za-z0-9\-]+\.)+[A-Za-z0-9]+$/;
        if (!email.match(format)) {
            return false;
        }
        return true;
    }

    function isPhoneNumber(telNum){
        if(/^13\d{9}$/g.test(telNum)||(/^15\d{9}$/g.test(telNum))||(/^18\d{9}$/g.test(telNum))) return true;
        else return false;
    }
    function isFloat(values){
        var intR = /^\d+$/;
        var floatR = /^\d+(\.\d+)?$/;
        if(intR.test(values) == true || floatR.test(values) == true) return true;
        else return false;
    }
    </script>
    </body>
</html>
