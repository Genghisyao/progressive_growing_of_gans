<!DOCTYPE html>
<!--[if IE 9 ]>
<html class="ie9">
<![endif]-->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
        <meta name="format-detection" content="telephone=no">
        <meta charset="UTF-8">

        <meta name="description" content="Violate Responsive Admin Template">
        <meta name="keywords" content="Super Admin, Admin, Template, Bootstrap">

        <title>文件管理</title>
            
        <!-- CSS -->
        
        <link href="{$webroot}assets/css/animate.min.css" rel="stylesheet">
        <link href="{$webroot}assets/css/font-awesome.min.css" rel="stylesheet">
       <!--  <link href="/{$webroot}assets/css/form.css" rel="stylesheet"> -->
        <!-- <link href="/{$webroot}assets/css/style.css" rel="stylesheet"> -->
        <link href="{$webroot}assets/css/icons.css" rel="stylesheet">
        <link href="{$webroot}assets/css/generics.css" rel="stylesheet">
        <link href="{$webroot}assets/css/bootstrap.min.css" rel="stylesheet">

        <link href="{$webroot}assets/css/jquery.dataTables.css" rel="stylesheet">
        <link href="{$webroot}assets/css/jquery-ui.css" rel="stylesheet">
        <style type="text/css">
          html,body{width: 100%;height: 100%;}
          body{color:#666;}
          #main,#content{width: 100%;height: 100%;padding:10px 0px;}
          /*#content{padding: 10px;}*/

          .content{/*background-color: #fff;border:1px solid #ddd;*/border-radius: 5px!important;height: 100%;padding: 0px;margin: 0px;width: 100%;}
          .content>div{height: 100%;}
          .content>div>div{height: 100%;background-color: #fff;border:1px solid #ddd;border-radius: 5px;}
          #keywords,#eventList{height: 40%;min-height: 200px;}
          #artAndEvent{height: 60%;min-height: 300px;margin: 0px!important;padding: 0px;width: 100%;}
          #artAndEvent>div{height: 100%;}
          .title p{display: inline-block;border-bottom: 1px solid #435f76;color: #435f76;margin: 0px;padding: 10px 20px 5px 0px;font-size: 18px;}
          .title{border-bottom: 1px solid #ddd;padding-left: 10px;}
          
          #keywordsTable_wrapper{height: 100%;}
          #articlesTable_wrapper{height: 100%;}
          td{border-bottom-style: none!important;}
          table.dataTable.no-footer{border-bottom-style: none;}
          .dataTables_wrapper.no-footer .dataTables_scrollBody{border-bottom: 1px solid #ddd!important;}
          ::-webkit-scrollbar{width:5px;}
          ::-webkit-scrollbar-track{background-color:#f9f9f9;}
          ::-webkit-scrollbar-thumb{background-color:#bee1eb;}
          .choose{background-color: rgba(202, 66, 66, 0.21)!important;}
          .choose:hover{background-color: rgba(202, 66, 66, 0.21)!important;}
          .body{padding: 0px 10px;}

         
          #articles/*,#eventMessage*/{height: 60%;min-height: 300px;}
          #eventList .container{width: 100%;padding: 0px;}
          #eventList .container>div{padding: 0px;}
          .tips p{margin: 0px;}
          #eventList .body a{color: #666;}
          #eventList .body>.container{padding: 10px 0px;border-bottom: 1px solid #ddd;}
          #eventList>.body span{border:1px solid rgba(67, 95, 118,0.6);color: rgb(67, 95, 118);margin-right:5px;border-radius: 5px;}
          #eventList>.body span>a{padding: 2px 8px;color: rgb(67, 95, 118);}
          a:hover,a:active{text-decoration: none;}
          #eventList>.body span:hover{box-shadow: 0px 0px 5px rgba(67, 95, 118,0.6);}
          #eventList>.body span:active{background-color:rgba(67, 95, 118,0.6);color: #fff;}
          .tips span,.tips span:hover,.tips span:active{border-style: none!important;box-shadow: none!important;}
          .tips{display: none;}
          .editBackgroup{background-color: #f9f9f9;}
          .form-group>label{padding: 0px;}
          .help-block{display: none;color:#d74b4b;}
          #eventMessage>.body{padding-top: 10px;}
          /*#keywords,#articles,#eventList,#eventMessage{background-color: #fff;border:1px solid #ddd;margin: 10px;border-radius: 5px;}*/
          
          #keywords tbody>tr>td:nth-child(3) a{color: #666;}
          #keywords tbody>tr>td:nth-child(3) a:focus{color: red;}
          .chooseKeyword{color: red!important;}
        </style>
    </head>
    
    <body class="no-scroll" style="background-color: rgba(255, 255, 255, 0);">
        <section id="main" class="p-relative" role="main">
            <!-- Content -->
            <section id="content" class="container">
                <div class="container content">
                  <div class="col-md-7" style="padding-right: 0px;">
                    <div>
                      <div id="keywords">
                        <div class="title"><p>关键词聚类</p></div>
                        <div class="body">
                          <table id="keywordsTable" width="100%" class="table table-striped table-hover">
                            <thead>
                              <tr>
                                <td>时间</td>
                                <td class="text-center" style="min-width: 50px;">文章数</td>
                                <td>关键词</td>
                                <td style="min-width: 20px;"></td>
                              </tr>
                            </thead>
                          </table>
                        </div>
                      </div>
                      <div id="articles">
                        <div class="title"><p>文章列表</p></div>
                        <div class="body">
                          <table id="articlesTable" width="100%" class="table table-striped table-hover">
                            <thead>
                              <tr>
                                <td>发布时间</td>
                                <td>标题</td>
                              </tr>
                            </thead>
                          </table>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                  <div class="col-md-5">
                    <div>
                      <div id="eventList">
                        <div class="title">
                          <p>事件列表</p>
                        </div>
                        <div class="body" style="overflow: auto;">
                        </div>
                      </div>
                      <div id="eventMessage">
                        <div class="title">
                          <p>定义事件</p>
                        </div>
                        <div class="body">
                          <form class="form-horizontal">
                            <div class="form-group">
                              <label class="col-md-3 control-label"><span style="color: red;">*&nbsp;&nbsp;</span>事件名字：</label>
                              <div class="col-md-9">
                                <input type="text" class="form-control" id="eventName">
                              </div>
                            </div>
                            <div class="form-group">
                              <label class="col-md-3 control-label"><span style="color: red;">*&nbsp;&nbsp;</span>关键字：</label>
                              <div class="col-md-9">
                                <input type="text" class="form-control" id="key">
                                <span class="help-block">多个关键字之间用逗号隔开。</span>
                              </div>
                            </div>
                            <div class="form-group">
                              <label class="col-md-3 control-label">反关键字：</label>
                              <div class="col-md-9">
                                <input type="text" class="form-control" id="disKey">
                                <span class="help-block">多个反关键字之间用逗号隔开。</span>
                              </div>
                            </div>
                            <div class="form-group">
                              <label class="col-md-3 control-label"><span style="color: red;">*&nbsp;&nbsp;</span>事件起始时间：</label>
                              <div class="col-md-9">
                                <input type="text" class="form-control" id="startTime" onfocus="showDate();">
                                
                              </div>
                            </div>
                            <div class="form-group">
                              <div class="col-sm-offset-2 col-sm-10 text-right">
                                <div class="btn btn-primary" id="cancel" style="display: none;" onclick="cancelEdit();">取消</div>
                                <div class="btn btn-primary" id="submit" onclick="addEvents();">提交</div>
                              </div>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                 
                  
                </div>
            </section>
        </section>
        
        <!-- Javascript Libraries -->
        <!-- jQuery -->
        <script src="{$webroot}assets/js/jquery.min.js"></script> <!-- jQuery Library -->
        <script src="{$webroot}assets/js/jquery-ui.min.js"></script> <!-- jQuery UI -->
        
        <!-- Bootstrap -->
        <script src="{$webroot}assets/js/bootstrap.min.js"></script>
        <script src="{$webroot}assets/js/resize.js"></script>
          
        
        <!-- UX -->
        <script src="{$webroot}assets/js/scroll.min.js"></script> <!-- Custom Scrollbar -->
        <script src="{$webroot}assets/js/echarts.min.js"></script>
        <script src="{$webroot}assets/js/jquery.dataTables.min.js"></script>   <!-- datatables -->
        
        <!-- All JS functions -->
        <script type="text/javascript">
          var dataList; //保存ajax数据
          var articlesTable;
          window.onload=function(){
            setBodyHeight();
            
            $.ajax({
              url:'/cluster/api_cluster_analysis',
              dataType:'json',
              type:'post',
              success:function(result){
               /* console.log(result);*/
                dataList=result;
                var keywordsList=[];
                for(var i=0;i<result.length;i++){
                  keywordsList[i]={};
                  keywordsList[i].add_datetime=result[i].add_datetime;
                  keywordsList[i].quantity=result[i].quantity;
                  keywordsList[i].keywords=result[i].keywords;
                  keywordsList[i].id=i;
                }
                $("#keywordsTable").dataTable({
                      "bLengthChange": false, //改变每页显示数据数量
                      "bFilter": false, //过滤功能
                      /*"bSort": true,*/
                      "paging": false,
                      "bProcessing": true,
                      "aoColumnDefs": [ { "bSortable": false, "aTargets": [ 2 ,3] }] ,
                      "order":[[1, 'desc']],
                      
                      "iDisplayLength": 100,
                      "bInfo": false,
                      "sScrollY":function(){
                        var bodyHeight=$(".body").height();
                        return bodyHeight-50;
                      }(),
                      "createdRow": function( row, data, dataIndex ) {
                            $(row).children('td').eq(1).attr('style', 'text-align: center;');
                            /*$(row).children('td').eq(2).attr('style', 'text-align: center;');*/
                            /*$(row).children('td').eq(4).attr('style', 'text-align: center;');
                            $(row).children('td').eq(5).attr('style', 'text-align: center;');
                            $(row).children('td').eq(6).attr('style', 'text-align: center;');
                            $(row).children('td').eq(7).attr('style', 'text-align: center;');
                            $(row).children('td').eq(8).attr('style', 'text-align: center;');
                            $(row).children('td').eq(9).attr('style', 'text-align: center;');*/
                        },
                      data:keywordsList,
                      columns:[ 
                          /*{'data':'event_id','createdCell':function(td){
                            $(td).css('display','none').addClass('IDtd');
                          }},
                          { 'data': 'event_name',"createdCell": function (td, cellData, rowData, row, col) {
                                                                    var text=$(td).html();
                                                                    var id=$(td).siblings('.IDtd').html();
                                                                    $(td).attr({'id':id,'onclick':'parent.setModel(this);parent.showModel();'});
                                                                    $(td).empty(); 
                                                                    $(td).append("<a href='#'>"+text+"</a>");
                                                                },
                          },*/
                          {'data':'add_datetime'},
                          { 'data': 'quantity'},
                          { 'data': 'keywords',"createdCell": function (td, cellData, rowData, row, col) {
                                                                    var text=$(td).html();
                                                                    var titleArr=text.split(',');
                                                                    var str='';
                                                                    for(var i=0;i<titleArr.length;i++){
                                                                      str+='<a href="#" onclick="showKeyArticles(this);">'+titleArr[i]+',</a>';
                                                                    }
                                                                    $(td).empty(); 
                                                                    $(td).append(str);
                                                                },
                          },
                          { 'data': 'id',"createdCell":function(td){
                            var text=$(td).html();
                            var htmlStr='<a href="#" id="'+text+'" onclick="showArticles(this);">查看</a>';
                            $(td).empty().append(htmlStr);
                          }}
                          
                      ]
                    })
                $("#keywordsTable tbody tr").eq(0).children("td").addClass("choose");
                var articlesList=dataList[0].value_list;
                /*console.log(dataList[0].value_list);
                for( var k in dataList[0].value_list){
                  console.log(k,dataList[0].value_list[k]);
                }*/
                articlesTable = $("#articlesTable").dataTable({
                      "searching":false,
                      "bLengthChange": false, //改变每页显示数据数量
                      "bFilter": false, //过滤功能
                      /*"bSort": true,*/
                      "bProcessing": true,
                      "aoColumnDefs": [ { "bSortable": false, "aTargets": [1] }] ,
                      "order":[[0, 'desc']],
                      
                      
                      "iDisplayLength": 100,
                      "bInfo": false,
                      "destroy":true,
                      "sScrollY":function(){
                        var bodyHeight=$(".body").eq(1).height();
                        return bodyHeight-100;
                      }(),
                      "aaData":articlesList,
                      "columns":[ 
                          { 'data': 'publish_datetime'},
                          { 'data': 'ttitle'}
                      ]
                    })
              }
              
            })
            
            deleteEvent();
            helpWord();
            setEventList();
            editEvent();
            $("#eventMessage .body").height($("#eventMessage").height()-$("#eventMessage .title").height()-10);
            $("#eventList").height($("#eventMessage").parent().height()-$("#eventMessage").height());
            $(".body").each(function(){
              $(this).height($(this).parent().height()-$(this).siblings('.title').height());
            })
          }

          $(window).resize(function(){
            setBodyHeight();
            sertScrollBodyHeight();
            $("#eventList").height($("#eventMessage").parent().height()-$("#eventMessage").height());
            $(".body").each(function(){
              $(this).height($(this).parent().height()-$(this).siblings('.title').height());
            })
          })

          //初始化.body高度
          function setBodyHeight(){
            $(".body").each(function(){
              $(this).height($(this).parent('div').height()-$(this).siblings('.title').height());
            })
          }

          //dataTables_scrollBody高度
          function sertScrollBodyHeight(){
            $(".dataTables_scrollBody").each(function(){
              $(this).height($(this).parent().parent('.dataTables_wrapper').height()-$(this).siblings(".dataTables_scrollHead").height()-$(this).parent().siblings(".dataTables_paginate").height()-20);
            })
          }
          //展示对应的文章
          function showArticles(item){
            /*$("#articles").show();*/
           /* setBodyHeight();*/
           var id=parseInt(item.id);
           $(".choose").removeClass("choose");
           $(".chooseKeyword").removeClass("chooseKeyword");
           $("#keywordsTable tbody tr").eq(id).children("td").addClass("choose");
          
                var articlesList=dataList[id].value_list;
                /*console.log(articlesList);*/
                
                if( !!articlesTable ) articlesTable.api().destroy();

                articlesTable = $("#articlesTable").dataTable({
                      "searching":false,
                      "bLengthChange": false, //改变每页显示数据数量
                      "bFilter": false, //过滤功能
                      /*"bSort": true,*/
                      "bProcessing": true,
                      "aoColumnDefs": [ { "bSortable": false, "aTargets": [1] }] ,
                      "order":[[0, 'desc']],
                      
                      
                      "iDisplayLength": 100,
                      "bInfo": false,
                      "destroy":true,
                      "sScrollY":function(){
                        var bodyHeight=$(".body").eq(1).height();
                        return bodyHeight-100;
                      }(),
                      /*"createdRow": function( row, data, dataIndex ) {
                            $(row).children('td').eq(0).attr('style', 'text-align: center;');
                            $(row).children('td').eq(2).attr('style', 'text-align: center;');
                            $(row).children('td').eq(4).attr('style', 'text-align: center;');
                            $(row).children('td').eq(5).attr('style', 'text-align: center;');
                            $(row).children('td').eq(6).attr('style', 'text-align: center;');
                            $(row).children('td').eq(7).attr('style', 'text-align: center;');
                            $(row).children('td').eq(8).attr('style', 'text-align: center;');
                            $(row).children('td').eq(9).attr('style', 'text-align: center;');
                        },*/
                      "aaData":articlesList,
                      "columns":[ 
                          { 'data': 'publish_datetime'},
                          { 'data': 'ttitle'}
                      ]
                    })
             /* }
            })*/
          }

          //点击关键字显示文章
          function showKeyArticles(item){
            $(".choose").removeClass("choose");
            $(".chooseKeyword").removeClass("chooseKeyword");
            $(item).addClass("chooseKeyword");
            var keyWords=item.innerHTML.replace(',','');
            var postData={};
            postData.word=keyWords;
            $.ajax({
              url:'/search/api_search_arcticle',
              postData:'json',
              data:postData,
              type:'post',
              success:function(result){
                var json = eval('(' + result + ')'); 
               /* console.log(json);*/
                $("#articlesTable").dataTable({
                      "searching":false,
                      "bLengthChange": false, //改变每页显示数据数量
                      "bFilter": false, //过滤功能
                      /*"bSort": true,*/
                      "bProcessing": true,
                      "aoColumnDefs": [ { "bSortable": false, "aTargets": [1] }] ,
                      "order":[[0, 'desc']],
                      "iDisplayLength": 100,
                      "bInfo": false,
                      "destroy":true,
                      "sScrollY":function(){
                        var bodyHeight=$(".body").eq(1).height();
                        return bodyHeight-100;
                      }(),
                      "aaData":json,
                      "columns":[ 
                          { 'data': 'publish_datetime'},
                          { 'data': 'title'}
                      ]
                    })
              }
            })
          }

          //显示关键字、反关键字信息
          function showTips(item){
            $(item).parent().parent().siblings(".tips").slideToggle();
          }

          //显示日历
          function showDate(){

              $('#startTime').datepicker();    

          };

          //进入页面时加载事件列表
          function setEventList(){
            $.ajax({
                    url: "/event/api_get_eventlist",
                    type:"post",
                    dataType: "json",
                    success: function(result){ 
                     /* console.log(result);*/
                      var str="";
                      for(var i=0;i<result.length;i++){
                       
                        str+="<div class='container'><div class='container' id='"+result[i].event_id+"'><div class='col-md-6'><a href='javascript:void(0)'  onclick='showTips(this);' style='display:block;'>"+result[i].event_name+"</a></div><div class='col-md-6 text-right'><span><a href='#' class='edit'>修改</a></span><span><a href='#' class='delete'>删除</a></span></div></div>";
                        
                        str+='<div class="tips"><p><span class="key">关键字：</span>';
                        if (!result[i].keywords) {
                          str+='-<p><p><span class="disKey">反关键字：</span>';
                        }else{
                          str+=result[i].keywords+'</p><p><span class="disKey">反关键字：</span>';
                        }
                        if (!result[i].non_keywords) {
                         str+='-</p></div></div>'; 
                        }else{
                          str+=result[i].non_keywords+'</p></div></div>';
                        }

                       
                      }
                      $("#eventList .body").append(str);

                    }                           
                  });
            
          }
          //往左侧事件列表增加事件名
          function addEvents(){
            if (confirm("确定提交？")) {
                var length=$("#eventList .body .Editing").length;
                var id;
                var time;
                var startTimeArr
                var startTime='';
                if (length) {
                  id=$(".Editing").attr("id");
                  $(".Editing").removeClass("Editing");
                  $(".editBackgroup").removeClass("editBackgroup");
                  time='';
                  var reg=/-/;
                  if (reg.test($("#startTime").val())) {
                    startTime=$("#startTime").val()+' 0:0:0';

                  }else{
                    startTimeArr=$("#startTime").val().split('/');
                    startTime=startTimeArr[2]+'-'+startTimeArr[0]+'-'+startTimeArr[1]+' 0:0:0';
                  }
                }else{
                  id=-1;
                  time=new Date();
                  var month=time.getMonth()+1;
                  time=time.getFullYear()+"-"+month+"-"+time.getDate()+" "+time.getHours()+":"+time.getMinutes()+":"+time.getSeconds();
                  startTimeArr=$("#startTime").val().split('/');
                  startTime=startTimeArr[2]+'-'+startTimeArr[0]+'-'+startTimeArr[1]+' 0:0:0';
                } 
                var name=$("#eventName").val();
                var key=$("#key").val();
                key=key.replace(/，/g, ",");
                var disKey=$("#disKey").val();
                var startT=$("#startTime").val();
                
                
               
                if(name&&key&&startT){
                  var postData={};
                  postData.event_id=id;
                  postData.event_name=name;
                  postData.add_datetime=time;
                  postData.keywords=key;
                  postData.non_keywords=disKey;
                  postData.start_datetime=startTime;
                  console.log(postData);
                  $.ajax({
                    url: "/event/api_set_eventlist",
                    data:postData,
                    type:"post",
                    dataType: "json",
                    success: function(result){
                      $("#eventList .body").empty();
                      var str="";
                      for(var i=0;i<result.length;i++){
                        
                        str+="<div class='container'><div class='container' id='"+result[i].event_id+"'><div class='col-md-9'><a href='javascript:void(0)'  onclick='showTips(this);' style='display:block;'>"+result[i].event_name+"</a></div><div class='col-md-3'><span><a href='#' class='edit'>修改</a></span><span><a href='#' class='delete'>删除</a></span></div></div>";
                            
                        str+='<div class="tips"><p><span class="key">关键字：</span>';
                        if (result[i].keywords=="") {
                          str+='-<p><p><span class="disKey">反关键字：</span>';
                        }else{
                          str+=result[i].keywords+'</p><p><span class="disKey">反关键字：</span>';
                        }
                        if (result[i].non_keywords=="") {
                         str+='-</p></div></div>'; 
                        }else{
                          str+=result[i].non_keywords+'</p></div></div>';
                        }
                        
                      }
                      $("#eventList .body").append(str);
                      $("#eventName").val("");
                      $("#key").val("");
                      $("#disKey").val("");
                      $("#startTime").val("");
                      $("#cancel").hide();
                    }                           
                  });

                }else{
                  alert("请补充完整信息。");
                }
            }else{

            }  
          }

          //提示信息显示/消失
          function helpWord(){
            $(".form-control").focus(function(){
              $(this).siblings(".help-block").show();
            }).blur(function(){
              $(this).siblings(".help-block").hide();
            })
          }

          //删除事件
          function deleteEvent(){
           
            $(document).on("click", "#eventList .delete", function () {
                  var del=confirm("确定要删除该事件？");
                  if (del==true){
                    var postData={};
                    postData.event_id=$(this).parent().parent().parent("div.container").attr("id");
                    /*console.log(postData);*/
                    $.ajax({
                      url:"/event/api_delete_eventlist",
                      data:postData,
                      type:"post",
                      dataType: "json",
                      success: function(result){
                      }
                    })
                    $(this).parent().parent().parent().parent("div.container").remove();
                  }else{}
                  
              })

          }

          //修改事件
          function editEvent(){
            $(document).on("click","#eventList .edit",function(){
              $("#cancel").show();
              $(".Editing").removeClass("Editing");
              $(".editBackgroup").removeClass("editBackgroup");
              $(this).parent().parent().parent().addClass("Editing");
              $(this).parent().parent().parent().parent().addClass("editBackgroup");
              var id=$(".Editing").attr("id");
              var postData={};
              postData.event_id=id;
              $.ajax({
                url:'/event/api_update_eventlist',
                type:'post',
                dataType:'json',
                data:postData,
                success:function(result){
                  /*console.log(result);*/
                  $("#eventName").val(result[0].event_name);
                  $("#key").val(result[0].keywords);
                  $("#disKey").val(result[0].non_keywords);
                  $("#startTime").val(result[0].start_datetime.split(' ')[0]);
                }
              })
            })
          }

          //取消修改
          function cancelEdit(){
            $("#cancel").hide();
            $(".Editing").removeClass("Editing");
            $(".editBackgroup").removeClass("editBackgroup");
            $("#eventName").val("");
            $("#key").val("");
            $("#disKey").val("");
            $("#startTime").val("");
          }
        </script>
      
    </body>
</html>

